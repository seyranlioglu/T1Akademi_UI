<div class="section-card bg-white border rounded-3 mb-3 shadow-sm overflow-hidden">
    
    <div class="section-header p-3 d-flex align-items-center justify-content-between bg-light border-bottom">
        <div class="d-flex align-items-center gap-3 flex-grow-1">
            
            <div class="drag-handle text-muted cursor-move" cdkDragHandle>
                <i class='bx bx-grid-vertical fs-4'></i>
            </div>

            <div class="fw-bold text-dark d-flex align-items-center gap-2 flex-grow-1">
                <span class="text-muted text-nowrap">Bölüm {{index}}:</span>
                
                <span *ngIf="!sectionTitleEdit" class="text-truncate cursor-pointer" (click)="toggleExpand()">
                    {{ data.trainingSectionTitle || data.title }}
                </span>
                
                <input *ngIf="sectionTitleEdit" 
                       [(ngModel)]="data.trainingSectionTitle" 
                       (blur)="updateSectionTitle()" 
                       (keydown.enter)="updateSectionTitle()" 
                       class="form-control form-control-sm w-100" autoFocus>
                
                <i *ngIf="!sectionTitleEdit" class='bx bx-pencil text-muted cursor-pointer hover-primary ms-2' (click)="$event.stopPropagation(); sectionTitleEdit = true"></i>
            </div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <button class="btn btn-sm btn-outline-danger border-0" (click)="$event.stopPropagation(); deleteSection()"><i class='bx bx-trash'></i></button>
            <i class='bx fs-4 cursor-pointer text-muted' (click)="toggleExpand()" [ngClass]="isExpanded ? 'bx-chevron-up' : 'bx-chevron-down'"></i>
        </div>
    </div>

    <div class="section-body p-3 bg-white" *ngIf="isExpanded">
        
        <div cdkDropList [cdkDropListData]="data.trainingContents" (cdkDropListDropped)="contentDropped.emit($event)" class="d-flex flex-column gap-2">
            <app-course-content *ngFor="let content of data.trainingContents" [data]="content" cdkDrag>
                <div *cdkDragPlaceholder class="custom-placeholder"></div>
            </app-course-content>
        </div>

        <div *ngIf="!isNewContentFormVisible" class="mt-3 text-center">
            <button class="btn btn-outline-primary btn-sm rounded-pill px-4" (click)="toggleNewContentForm()">
                <i class='bx bx-plus'></i> Ders Ekle
            </button>
        </div>

        <div *ngIf="isNewContentFormVisible" class="new-content-card mt-3 border rounded shadow-sm">
            
            <div class="d-flex align-items-center gap-2 p-3 border-bottom bg-light-subtle">
                <input type="text" class="form-control" placeholder="Ders başlığını giriniz..." [(ngModel)]="newContentTitle">
                <button class="btn btn-light border" (click)="isSettingsDialogVisible = true" title="Ders Ayarları">
                    <i class='bx bx-cog'></i>
                </button>
            </div>

            <div class="p-3">
                <div class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                    <button class="nav-link btn-sm" [class.active]="newContentType === 'material'" (click)="newContentType = 'material'">
                        <i class='bx bx-video'></i> Video / Belge
                    </button>
                    <button class="nav-link btn-sm" [class.active]="newContentType === 'exam'" (click)="newContentType = 'exam'">
                        <i class='bx bx-task'></i> Sınav
                    </button>
                </div>

                <div *ngIf="newContentType === 'material'">
                    <div *ngIf="!selectedLibraryItem" class="upload-placeholder p-4 text-center border-dashed rounded cursor-pointer hover-bg-light" 
                         (click)="openLibrarySelector()">
                        <i class='bx bx-cloud-upload display-4 text-primary mb-2'></i>
                        <h6 class="fw-bold">Kütüphaneden İçerik Seç</h6>
                        <p class="small text-muted mb-0">Video veya PDF dosyalarınızı bağlayın.</p>
                    </div>

                    <div *ngIf="selectedLibraryItem" class="selected-item-card d-flex align-items-center gap-3 p-3 border rounded bg-white">
                        <img [src]="selectedLibraryItem.thumbnail || 'assets/images/file-types/file.png'" class="rounded" width="60" height="60" style="object-fit: cover;">
                        <div class="flex-grow-1 overflow-hidden">
                            <h6 class="mb-1 text-truncate">{{ selectedLibraryItem.fileName }}</h6>
                            <span class="badge bg-light text-secondary border">{{ selectedLibraryItem.fileType?.includes('video') ? 'Video' : 'Belge' }}</span>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" (click)="selectedLibraryItem = null">Değiştir</button>
                    </div>
                </div>

                <div *ngIf="newContentType === 'exam'">
                    <app-exam-selector
                        [label]="'Sınav Seçiniz'"
                        (onExamSelect)="onExamSelected($event)">
                    </app-exam-selector>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2 p-3 border-top bg-light-subtle">
                <button class="btn btn-light btn-sm" (click)="toggleNewContentForm()">İptal</button>
                <button class="btn btn-dark btn-sm px-4" (click)="saveContent()" 
                        [disabled]="!newContentTitle || (newContentType === 'material' && !selectedLibraryItem) || (newContentType === 'exam' && !selectedExamItem)">
                    <i class='bx bx-save'></i> Kaydet
                </button>
            </div>
        </div>

    </div>
</div>

<p-dialog header="Ders Ayarları" 
          [(visible)]="isSettingsDialogVisible" 
          [modal]="true" 
          [style]="{width: '400px'}" 
          [draggable]="false" 
          [resizable]="false"
          [contentStyle]="{'overflow': 'visible'}">
    
    <div class="d-flex flex-column gap-3 p-4 bg-white rounded">
        
        <div class="form-check form-switch d-flex justify-content-between align-items-center border-bottom pb-2">
            <label class="form-check-label" for="mandatorySwitch">
                <span class="fw-bold d-block">Zorunlu İçerik</span>
                <small class="text-muted">Öğrenci bu dersi geçmek zorunda.</small>
            </label>
            <input class="form-check-input" type="checkbox" id="mandatorySwitch" [(ngModel)]="contentSettings.mandatory">
        </div>

        <div class="form-check form-switch d-flex justify-content-between align-items-center border-bottom pb-2">
            <label class="form-check-label" for="previewSwitch">
                <span class="fw-bold d-block">Önizleme (Vitrin)</span>
                <small class="text-muted">Satın almadan önce izlenebilir.</small>
            </label>
            <input class="form-check-input" type="checkbox" id="previewSwitch" [(ngModel)]="contentSettings.isPreview">
        </div>

        <div class="form-check form-switch d-flex justify-content-between align-items-center border-bottom pb-2">
            <label class="form-check-label" for="seekingSwitch">
                <span class="fw-bold d-block">İleri Sarma İzni</span>
                <small class="text-muted">Video ileri sarılabilir mi?</small>
            </label>
            <input class="form-check-input" type="checkbox" id="seekingSwitch" [(ngModel)]="contentSettings.allowSeeking">
        </div>

        <div class="border-bottom pb-2">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="fw-bold small m-0">Tamamlanma Kabul Oranı</label>
                <span class="badge bg-primary rounded-pill">%{{ contentSettings.completedRate }}</span>
            </div>
            
            <input type="range" 
                   class="form-range custom-range" 
                   [(ngModel)]="contentSettings.completedRate" 
                   min="1" max="100" step="5"
                   (mousedown)="$event.stopPropagation()"
                   (touchstart)="$event.stopPropagation()"
                   (click)="$event.stopPropagation()">
            
            <small class="text-muted d-block mt-1 text-center fst-italic" style="font-size: 0.7rem;">
                Videonun <strong class="text-dark">%{{ contentSettings.completedRate }}</strong> kısmı izlenince tamamlandı sayılacak.
            </small>
        </div>

    </div>
    <ng-template pTemplate="footer">
        <button class="btn btn-primary btn-sm w-100" (click)="isSettingsDialogVisible = false">Tamam</button>
    </ng-template>
</p-dialog>