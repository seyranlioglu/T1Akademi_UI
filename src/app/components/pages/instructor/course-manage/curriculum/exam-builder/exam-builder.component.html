<div class="modal-content-wrapper d-flex flex-column h-100 position-relative">
    
    <div class="modal-header border-bottom px-4 py-3 d-flex justify-content-between align-items-center bg-white">
        <div class="d-flex align-items-center gap-3">
            <h5 class="modal-title fw-bold text-dark mb-0">
                {{ examId ? 'Sınavı Düzenle' : 'Yeni Sınav Oluştur' }}
            </h5>
            
            <div class="dropdown" *ngIf="examId && versionList.length > 0">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle d-flex align-items-center gap-2" 
                        type="button" data-bs-toggle="dropdown">
                    <span class="badge" 
                          [ngClass]="isPublishedVersion ? 'bg-success' : 'bg-warning text-dark'">
                          {{ isPublishedVersion ? 'Yayında' : 'Taslak' }}
                    </span>
                    <span class="fw-bold">v{{ currentExamDetail?.activeVersions?.versionNo }}</span>
                </button>
                <ul class="dropdown-menu shadow border-0" style="max-height: 300px; overflow-y: auto;">
                    <li *ngFor="let v of versionList">
                        <a class="dropdown-item d-flex justify-content-between align-items-center" 
                           [class.active]="v.versionId === selectedVersionId"
                           (click)="onVersionChange(v.versionId)" 
                           style="cursor: pointer;">
                            <div>
                                <span class="fw-bold">v{{ v.versionNumber }}</span>
                                <small class="text-muted d-block" style="font-size: 0.7rem;">{{ v.createdDate | date:'dd.MM.yyyy HH:mm' }}</small>
                            </div>
                            <span class="badge ms-2" 
                                  [ngClass]="v.isPublished ? 'bg-success' : (v.statusTitle === 'Old Version' ? 'bg-secondary' : 'bg-warning text-dark')">
                                {{ v.isPublished ? 'Yayında' : v.statusTitle }}
                            </span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm d-flex align-items-center gap-1" 
                    *ngIf="examId && !isPublishedVersion" 
                    (click)="publishVersion()">
                <i class='bx bx-check-double'></i> Bu Versiyonu Yayına Al
            </button>

            <button type="button" class="btn-close" (click)="close()"></button>
        </div>
    </div>

    <div class="bg-white border-bottom px-4">
        <ul class="nav nav-tabs border-bottom-0">
            <li class="nav-item">
                <a class="nav-link cursor-pointer fw-medium py-3" 
                   [class.active]="activeTab === 'settings'"
                   [class.text-primary]="activeTab === 'settings'"
                   [class.text-muted]="activeTab !== 'settings'"
                   (click)="switchTab('settings')">
                   <i class='bx bx-cog me-1'></i> Genel Ayarlar
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link cursor-pointer fw-medium py-3" 
                   [class.active]="activeTab === 'curriculum'"
                   [class.text-primary]="activeTab === 'curriculum'"
                   [class.disabled]="!examId"
                   [class.text-muted]="activeTab !== 'curriculum'"
                   (click)="switchTab('curriculum')">
                   <i class='bx bx-list-ul me-1'></i> Konular ve Sorular
                </a>
            </li>
        </ul>
    </div>

    <div class="modal-body bg-light p-4 overflow-auto" style="min-height: 400px; max-height: 70vh;">
        
        <div *ngIf="isLoading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
        </div>

        <div *ngIf="activeTab === 'settings' && !isLoading" class="container-fluid px-0">
            <form [formGroup]="examForm">
                <div class="card border-0 shadow-sm p-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold small">Sınav Başlığı <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" formControlName="title" placeholder="Örn: İş Sağlığı ve Güvenliği Sınavı">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small">Açıklama</label>
                        <textarea class="form-control" rows="3" formControlName="description" placeholder="Sınav hakkında kısa bilgi..."></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold small">Sınav Süresi (HH:mm:ss)</label>
                            <input type="text" class="form-control" formControlName="examTime" placeholder="00:30:00">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold small">Geçme Notu (%)</label>
                            <input type="number" class="form-control" formControlName="passingScore">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold small">Başarı Hedefi (%)</label>
                            <input type="number" class="form-control" formControlName="successRate">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold small text-danger">Başarısız Olursa</label>
                            <select class="form-select" formControlName="actionId">
                                <option *ngFor="let action of failureActions" [value]="action.id">{{ action.title }}</option>
                            </select>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div *ngIf="activeTab === 'curriculum' && !isLoading">
            
            <div *ngIf="isQuestionFormVisible" class="card border-0 shadow-sm mb-4 border-start border-4 border-primary">
                <div class="card-header bg-white py-3 border-bottom-0">
                    <h6 class="fw-bold m-0 text-primary">
                        {{ editingQuestionId ? 'Soruyu Düzenle' : 'Yeni Soru Ekle' }}
                    </h6>
                </div>
                <div class="card-body pt-0" [formGroup]="questionForm">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Soru Metni</label>
                        <textarea class="form-control" rows="2" formControlName="questionText" placeholder="Sorunuzu buraya yazın..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Puan</label>
                        <input type="number" class="form-control w-25" formControlName="score">
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold d-block">Şıklar (Doğru cevabı işaretleyin)</label>
                        <div formArrayName="options">
                            <div *ngFor="let opt of options.controls; let i=index" [formGroupName]="i" class="d-flex align-items-center gap-2 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" [checked]="opt.value.isCorrect" (change)="setCorrectOption(i)">
                                </div>
                                <input type="text" class="form-control form-control-sm" formControlName="optionText" placeholder="Seçenek metni">
                                <button class="btn btn-icon btn-sm text-danger" (click)="removeOption(i)" *ngIf="options.length > 2">
                                    <i class='bx bx-trash'></i>
                                </button>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-light text-primary border mt-2" (click)="addOption()">
                            <i class='bx bx-plus'></i> Seçenek Ekle
                        </button>
                    </div>

                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm" (click)="saveQuestion()">Soruyu Kaydet</button>
                        <button class="btn btn-light btn-sm border" (click)="cancelQuestionForm()">İptal</button>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="fw-bold m-0">Sınav Müfredatı</h6>
                <button class="btn btn-sm btn-outline-dark" (click)="openTopicForm()" *ngIf="!isTopicFormVisible && !isQuestionFormVisible">
                    <i class='bx bx-folder-plus me-1'></i> Yeni Konu Ekle
                </button>
            </div>

            <div *ngIf="isTopicFormVisible" class="card border mb-3 bg-light shadow-sm">
                <div class="card-header bg-transparent border-0 fw-bold pb-0">
                    {{ editingTopicId ? 'Konuyu Düzenle' : 'Yeni Konu Ekle' }}
                </div>
                <div class="card-body" [formGroup]="topicForm">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label small fw-bold">Konu Başlığı</label>
                            <input type="text" class="form-control" formControlName="title" placeholder="Örn: Bölüm 1 - Giriş">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small fw-bold">Sıra No</label>
                            <input type="number" class="form-control" formControlName="seqNumber">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small fw-bold" title="Bu konudan sınavda kaç soru çıkacak? Boş bırakılırsa hepsi çıkar.">Soru Kotası</label>
                            <input type="number" class="form-control" formControlName="questionCount" placeholder="Tümü">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label small fw-bold">Konu Görseli</label>
                            <div class="d-flex align-items-center gap-3">
                                <div class="img-preview-box border rounded bg-white d-flex align-items-center justify-content-center"
                                     style="width: 80px; height: 60px; overflow: hidden;">
                                    <img *ngIf="topicForm.get('imgPath')?.value" 
                                         [src]="topicForm.get('imgPath')?.value" 
                                         class="w-100 h-100 object-fit-cover">
                                    <i *ngIf="!topicForm.get('imgPath')?.value" class='bx bx-image fs-3 text-muted opacity-25'></i>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" (click)="openImageSelector()">
                                    <i class='bx bx-image-add me-1'></i> 
                                    {{ topicForm.get('imgPath')?.value ? 'Görseli Değiştir' : 'Görsel Seç' }}
                                </button>
                                <button *ngIf="topicForm.get('imgPath')?.value" 
                                        type="button" 
                                        class="btn btn-sm btn-link text-danger text-decoration-none" 
                                        (click)="topicForm.patchValue({imgPath: ''})">
                                    Kaldır
                                </button>
                            </div>
                            <div class="form-text tiny-text mt-1">Sınav esnasında bu konu başladığında gösterilecek görsel.</div>
                        </div>
                    </div>
                    
                    <div class="mt-3 d-flex gap-2">
                        <button class="btn btn-success btn-sm px-4" (click)="saveTopic()">Kaydet</button>
                        <button class="btn btn-light btn-sm border px-3" (click)="cancelTopicForm()">İptal</button>
                    </div>
                </div>
            </div>

            <div class="accordion cdk-drop-list" cdkDropList (cdkDropListDropped)="onTopicDrop($event)">
                
                <div class="accordion-item border-0 mb-3 shadow-sm rounded overflow-hidden cdk-drag" 
                     *ngFor="let topic of currentExamDetail?.activeVersions?.topics; let i = index"
                     cdkDrag>
                    
                    <div class="drag-placeholder" *cdkDragPlaceholder></div>
                    
                    <h2 class="accordion-header d-flex align-items-center bg-white border-bottom">
                        
                        <div class="drag-handle px-3 cursor-move text-muted" cdkDragHandle title="Sıralamak için sürükleyin">
                            <i class='bx bx-grid-vertical fs-4'></i>
                        </div>

                        <button class="accordion-button bg-white text-dark shadow-none fw-bold border-0 p-3 ps-0" type="button" 
                                (click)="toggleTopic(topic.id)"
                                [class.collapsed]="isTopicCollapsed(topic.id)">
                            
                            <div class="d-flex align-items-center w-100">
                                <span class="badge bg-secondary me-3 rounded-circle" style="width:24px; height:24px; display:flex; align-items:center; justify-content:center;">{{ i + 1 }}</span>
                                <span class="me-auto">{{ topic.title }}</span>
                            </div>
                            
                            <div class="d-flex align-items-center gap-2 me-3" (click)="$event.stopPropagation()">
                                <img *ngIf="topic.imgPath" [src]="topic.imgPath" class="rounded border" style="width: 30px; height: 30px; object-fit: cover;" title="Konu Görseli">
                                <small class="text-muted fw-normal me-2" *ngIf="topic.questionCount">
                                    (Kota: {{ topic.questionCount }})
                                </small>
                                <span class="badge bg-light text-secondary border">{{ topic.questions?.length || 0 }} Soru</span>
                                <button class="btn btn-icon btn-sm" (click)="openTopicForm(topic)"><i class='bx bx-edit text-primary'></i></button>
                                <button class="btn btn-icon btn-sm" (click)="deleteTopic(topic.id)"><i class='bx bx-trash text-danger'></i></button>
                            </div>
                        </button>
                    </h2>

                    <div class="accordion-collapse collapse" [class.show]="!isTopicCollapsed(topic.id)">
                        <div class="accordion-body bg-white">
                            <div *ngIf="topic.questions && topic.questions.length > 0; else noQuestions">
                                <div *ngFor="let q of topic.questions; let qi = index" class="d-flex align-items-start justify-content-between p-2 border-bottom hover-bg-light">
                                    <div class="d-flex gap-3">
                                        <span class="fw-bold text-muted">{{ qi + 1 }}.</span>
                                        <div>
                                            <p class="m-0 mb-1 fw-medium">{{ q.questionText }}</p>
                                            <div class="d-flex flex-wrap gap-2">
                                                <span *ngFor="let opt of q.options" 
                                                      class="badge border fw-normal"
                                                      [ngClass]="opt.isCorrect ? 'bg-success-subtle text-success border-success' : 'bg-light text-muted'">
                                                    {{ opt.optionText }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex flex-column align-items-end gap-1">
                                        <span class="badge bg-secondary">{{ q.score }} Puan</span>
                                        <div class="d-flex gap-2 mt-1">
                                            <i class='bx bx-pencil text-muted cursor-pointer' (click)="openQuestionForm(topic.id, q)"></i>
                                            <i class='bx bx-trash text-danger cursor-pointer' (click)="deleteQuestion(q.id)"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <ng-template #noQuestions>
                                <p class="text-muted small text-center my-3 fst-italic">Bu konuda henüz soru yok.</p>
                            </ng-template>

                            <div class="mt-3 text-center" *ngIf="!isQuestionFormVisible">
                                <button class="btn btn-sm btn-link text-decoration-none" (click)="openQuestionForm(topic.id)">
                                    <i class='bx bx-plus-circle'></i> Soru Ekle
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div *ngIf="!currentExamDetail?.activeVersions?.topics?.length && !isTopicFormVisible" class="text-center py-5 border rounded border-dashed">
                <i class='bx bx-folder-open fs-1 text-muted opacity-50 mb-2'></i>
                <p class="text-muted m-0">Henüz hiç konu eklenmemiş.</p>
                <button class="btn btn-primary btn-sm mt-3" (click)="openTopicForm()">İlk Konuyu Ekle</button>
            </div>

        </div>

    </div>

    <div class="modal-footer bg-white border-top px-4 py-3">
        <button type="button" class="btn btn-light border" (click)="close()">Kapat</button>
        
        <button type="button" class="btn btn-primary px-4" 
                *ngIf="activeTab === 'settings'" 
                (click)="saveSettings()"
                [disabled]="isLoading">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
            {{ examId ? 'Değişiklikleri Kaydet' : 'Sınavı Oluştur ve Devam Et' }}
        </button>
    </div>

</div>

<ng-template #imageSelectorModal let-modal>
    <div class="modal-header border-bottom px-4 py-3">
        <h5 class="modal-title fw-bold text-dark m-0">Görsel Seç</h5>
        <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
    </div>
    <div class="modal-body p-0" style="height: 80vh; overflow: hidden;">
        <app-content-library-selector 
            [fileType]="'image'" 
            [returnType]="'path'"
            (onSelect)="onImageSelected($event)"
            (onCancel)="onImageSelectionCancel()">
        </app-content-library-selector>
    </div>
</ng-template>