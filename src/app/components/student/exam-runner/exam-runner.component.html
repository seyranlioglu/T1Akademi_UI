<div class="exam-runner-wrapper" [class.loading]="isLoading">
    
    <div class="loading-overlay" *ngIf="isLoading">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 text-white">İşlem yapılıyor...</p>
    </div>

    <div class="exam-intro-container d-flex align-items-center justify-content-center h-100 bg-light" 
         *ngIf="!isLoading && !isExamStarted && !showResultScreen && examContext">
        <div class="intro-card text-center p-5 shadow-lg rounded-4 bg-white" style="max-width: 600px; width: 100%;">
            <div class="mb-4">
                <div class="avatar-circle bg-primary bg-opacity-10 text-primary mx-auto d-flex align-items-center justify-content-center" style="width: 80px; height: 80px; border-radius: 50%;">
                    <i class='bx bx-book-reader fs-1'></i>
                </div>
            </div>
            <h3 class="fw-bold text-dark mb-2">{{ examContext.title }}</h3>
            <span class="badge bg-secondary mb-4">Versiyon: {{ examContext.version || '1.0' }}</span>
            <p class="text-muted mb-4">
                Bu sınav <strong>{{ totalQuestions }}</strong> sorudan oluşmaktadır.<br>
                Toplam süreniz <strong>{{ examContext.examTime || 'Belirsiz' }}</strong>'dir.
            </p>
            <div class="d-grid gap-2">
                <button class="btn btn-primary btn-lg py-3 fw-bold shadow-sm" (click)="startExamNow()">
                    Sınavı Başlat <i class='bx bx-right-arrow-alt'></i>
                </button>
                <button class="btn btn-outline-secondary" (click)="closeExam.emit(false)">Vazgeç</button>
            </div>
        </div>
    </div>

    <div class="exam-container" *ngIf="!isLoading && isExamStarted && !showResultScreen && examContext">
        <header class="exam-header">
            <div class="left-section">
                <h5 class="m-0 text-truncate">{{ examContext.title }}</h5>
                <span class="badge bg-warning text-dark ms-2" *ngIf="mode === 'preview'">ÖNİZLEME MODU</span>
            </div>
            <div class="center-section">
                <div class="timer-box" [class.critical]="timeLeft < 300">
                    <i class='bx bx-time-five'></i> <span>{{ timerDisplay }}</span>
                </div>
            </div>
            <div class="right-section">
                <button class="btn btn-danger btn-sm d-flex align-items-center gap-2" (click)="finishExam()">
                    <i class='bx bx-power-off'></i> Çıkış
                </button>
            </div>
        </header>

        <div class="exam-body">
            <aside class="exam-sidebar">
                <app-exam-sidebar 
                    [examData]="examContext" 
                    [currentSeq]="currentQuestionSeq" 
                    (selectQuestion)="onQuestionChanged($event)">
                </app-exam-sidebar>
            </aside>
            <main class="exam-content">
                <app-exam-question 
                    [userExamId]="examContext.userExamId" 
                    [currentSeq]="currentQuestionSeq"
                    [mode]="mode"
                    [previewToken]="previewToken"
                    [examId]="examId"
                    (next)="onQuestionChanged(currentQuestionSeq + 1)"
                    (prev)="onQuestionChanged(currentQuestionSeq - 1)"
                    (answerSaved)="onAnswerSaved()"
                    (finish)="finishExam()">
                </app-exam-question>
            </main>
        </div>
    </div>

    <div class="exam-result-container d-flex align-items-center justify-content-center h-100 bg-light" 
         *ngIf="!isLoading && showResultScreen && examResult">
        
        <div class="result-card text-center p-5 shadow-lg rounded-4 bg-white" style="max-width: 500px; width: 100%;">
            
            <div class="mb-4">
                <div class="avatar-circle mx-auto d-flex align-items-center justify-content-center animate-bounce" 
                     [ngClass]="examResult.isSuccess ? 'bg-success bg-opacity-10 text-success' : 'bg-danger bg-opacity-10 text-danger'"
                     style="width: 100px; height: 100px; border-radius: 50%;">
                    <i class='bx' [ngClass]="examResult.isSuccess ? 'bx-trophy' : 'bx-x-circle'" style="font-size: 3.5rem;"></i>
                </div>
            </div>

            <h2 class="fw-bold mb-1" [ngClass]="examResult.isSuccess ? 'text-success' : 'text-danger'">
                {{ examResult.isSuccess ? 'Tebrikler!' : 'Üzgünüz' }}
            </h2>
            <p class="text-muted mb-4">{{ examResult.message }}</p>

            <div class="score-box bg-light rounded-3 p-4 mb-4 border">
                <div class="row g-0">
                    <div class="col border-end">
                        <div class="small text-muted text-uppercase fw-bold">Puanınız</div>
                        <div class="display-6 fw-bold text-dark">{{ examResult.successRate | number:'1.0-0' }}</div>
                    </div>
                    <div class="col">
                        <div class="small text-muted text-uppercase fw-bold">Durum</div>
                        <div class="fs-4 fw-bold mt-2" [ngClass]="examResult.isSuccess ? 'text-success' : 'text-danger'">
                            {{ examResult.isSuccess ? 'GEÇTİ' : 'KALDI' }}
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn btn-lg w-100 py-3 fw-bold shadow-sm" 
                    [ngClass]="examResult.isSuccess ? 'btn-primary' : 'btn-dark'"
                    (click)="continueAfterExam()">
                
                <span *ngIf="isLastContent">Eğitimi Bitir <i class='bx bx-check-double ms-2'></i></span>
                <span *ngIf="!isLastContent">Sonraki Derse Geç <i class='bx bx-right-arrow-alt ms-2'></i></span>
            
            </button>

        </div>
    </div>

</div>