<div class="container-fluid py-4 position-relative overflow-hidden">

    <div class="bg-white p-3 rounded shadow-sm border mb-4">
        
        <div class="filter-header-row d-flex align-items-center justify-content-between">
            
            <div class="d-flex align-items-center gap-2 flex-shrink-0">
                <button class="btn btn-primary d-flex align-items-center gap-2" (click)="toggleFilter()">
                    <i class='bx bx-filter-alt'></i> 
                    <span class="d-none d-sm-inline">Filtreler</span>
                </button>
                <h5 class="fw-bold m-0 text-dark d-none d-md-block ms-2">Eğitim Kataloğu</h5>
            </div>

            <div class="d-flex align-items-center gap-3 flex-grow-1 justify-content-end" style="min-width: 0;">
                <div class="search-box-wrapper">
                    <input type="text" class="form-control form-control-sm ps-4" placeholder="Ara..." 
                           [(ngModel)]="filterRequest.searchText" (keyup.enter)="onSearch()">
                    <i class='bx bx-search position-absolute top-50 start-0 translate-middle-y ms-2 text-muted'></i>
                </div>
                <span class="text-muted small text-nowrap total-records-text">
                    <strong>{{ totalRecords }}</strong> sonuç
                </span>
            </div>
        </div>

        <div class="d-flex align-items-center mt-3 pt-3 border-top" *ngIf="selectedTags.length > 0">
            <span class="small text-muted me-2 fw-bold text-nowrap">Seçilenler:</span>
            
            <div class="d-flex gap-2 overflow-auto flex-grow-1 align-items-center custom-scrollbar pb-1">
                <button class="btn btn-sm btn-outline-danger rounded-pill d-flex align-items-center gap-1 flex-shrink-0 px-2 py-1" 
                        style="font-size: 12px;" (click)="resetAllFilters()">
                    <i class='bx bx-trash'></i> Temizle
                </button>

                <div *ngFor="let tag of selectedTags" 
                     class="badge bg-light text-dark border d-flex align-items-center gap-2 py-2 px-3 rounded-pill flex-shrink-0">
                    <span class="fw-normal">{{ tag.label }}</span>
                    <i class='bx bx-x cursor-pointer text-muted hover-danger' style="font-size: 1.1rem;" (click)="removeTag(tag)"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-0">
        
        <div class="col-12 transition-all">
             
             <div *ngIf="isLoading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-2">Yükleniyor...</p>
            </div>

            <div *ngIf="isSuggestionMode" class="alert alert-info d-flex align-items-center mb-4 border-0 shadow-sm" role="alert">
                <i class='bx bx-info-circle fs-4 me-2'></i>
                <div>
                    Aradığınız kriterlere uygun eğitim bulunamadı. Sizin için <strong>tüm eğitimleri</strong> listeledik.
                </div>
                <button class="btn-close ms-auto" (click)="isSuggestionMode = false"></button>
            </div>

            <div *ngIf="!isLoading && trainings.length === 0 && !isSuggestionMode" class="text-center py-5 bg-light rounded border border-dashed">
                <i class='bx bx-search-alt fs-1 text-muted mb-3'></i>
                <h5>Sonuç Bulunamadı</h5>
                <p class="text-muted">Sistemde henüz kayıtlı eğitim bulunmuyor.</p>
            </div>

            <div *ngFor="let item of trainings" class="card course-card border mb-3 shadow-sm hover-elevate">
                <div class="row g-0 h-100">
                    <div class="col-md-3 col-lg-3 col-xl-2 position-relative">
                        <a [routerLink]="['/course-details', item.id]" class="d-block h-100">
                            <img [src]="getCourseImage(item)" 
                                 (error)="handleImageError($event, item)"
                                 class="img-fluid h-100 w-100 object-fit-cover" 
                                 alt="Course">
                        </a>
                        <div *ngIf="item.isPrivate" class="position-absolute top-0 start-0 m-2 badge bg-danger shadow-sm">
                            <i class='bx bxs-lock-alt'></i> Özel
                        </div>
                    </div>
                    
                    <div class="col-md-9 col-lg-9 col-xl-10">
                        <div class="card-body p-3 d-flex flex-column h-100 justify-content-between">
                            
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="me-3">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <span class="badge bg-light text-primary border fw-normal" 
                                              [title]="'Kategori: ' + getCategoryPath(item.categoryId)">
                                            {{ getCategoryPath(item.categoryId) || item.categoryName }}
                                        </span>
                                        <span class="badge bg-light text-muted border fw-normal">{{ item.levelName }}</span>
                                    </div>
                                    
                                    <h6 class="card-title fw-bold text-dark mb-1 text-truncate-2">
                                        <a [routerLink]="['/course-details', item.id]" class="text-decoration-none text-dark hover-text-primary">
                                            {{ item.title }}
                                        </a>
                                    </h6>
                                    <small class="text-muted d-flex align-items-center gap-1">
                                        <i class='bx bx-user'></i> {{ item.instructorName }}
                                    </small>
                                </div>
                                
                                <div class="text-end flex-shrink-0">
                                    <div *ngIf="item.currentAmount > 0" class="mb-1">
                                        <h5 class="fw-bold text-primary mb-0">{{ item.currentAmount | currency:'TRY':'symbol-narrow':'1.0-0' }}</h5>
                                        <small *ngIf="item.discountRate > 0" class="text-muted text-decoration-line-through small">
                                            {{ item.amount | currency:'TRY':'symbol-narrow':'1.0-0' }}
                                        </small>
                                    </div>
                                    <div *ngIf="item.currentAmount === 0" class="mb-1">
                                        <span class="badge bg-success">ÜCRETSİZ</span>
                                    </div>
                                    <button class="btn btn-sm btn-icon btn-light rounded-circle text-muted hover-danger" title="Favorilere Ekle">
                                        <i class='bx bx-heart'></i>
                                    </button>
                                </div>
                            </div>

                            <div class="d-flex flex-wrap align-items-center justify-content-between pt-2 mt-auto border-top gap-2">
                                <div class="d-flex gap-3 text-muted small align-items-center">
                                    <span class="d-flex align-items-center gap-1 text-warning fw-bold">
                                        <i class='bx bxs-star'></i> {{ item.rating | number:'1.1-1' }} <span class="text-muted fw-normal">({{ item.reviewCount }})</span>
                                    </span>
                                    <span class="d-flex align-items-center gap-1">
                                        <i class='bx bx-time-five'></i> {{ item.totalMinutes }} dk
                                    </span>
                                    <span class="d-flex align-items-center gap-1 d-none d-sm-flex">
                                        <i class='bx bx-book-open'></i> {{ item.lessonCount }} ders
                                    </span>
                                </div>

                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-sm btn-outline-primary d-flex align-items-center gap-1 px-3">
                                        <i class='bx bx-cart-alt fs-6'></i> <span class="d-none d-md-inline">Sepete Ekle</span>
                                    </button>
                                    <a [routerLink]="['/course-details', item.id]" class="btn btn-sm btn-primary fw-bold px-3">
                                        İncele
                                    </a>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-center mt-4" *ngIf="totalRecords > filterRequest.pageSize">
                <nav aria-label="Page navigation">
                    <ul class="pagination pagination-sm">
                        <li class="page-item" [class.disabled]="filterRequest.pageIndex === 0">
                            <a class="page-link" href="javascript:void(0)" (click)="onPageChange(filterRequest.pageIndex - 1)">
                                <i class='bx bx-chevron-left'></i>
                            </a>
                        </li>
                        <li class="page-item" *ngFor="let p of pageArray" [class.active]="p === filterRequest.pageIndex">
                            <a class="page-link" href="javascript:void(0)" (click)="onPageChange(p)">{{ p + 1 }}</a>
                        </li>
                        <li class="page-item" [class.disabled]="filterRequest.pageIndex >= totalPages - 1">
                            <a class="page-link" href="javascript:void(0)" (click)="onPageChange(filterRequest.pageIndex + 1)">
                                <i class='bx bx-chevron-right'></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>

        <div class="filter-sidebar bg-white border-start shadow-lg" [class.open]="isFilterOpen">
            
            <div class="filter-tab d-flex align-items-center justify-content-center shadow-sm" (click)="toggleFilter()">
                <i class='bx bx-filter-alt me-2 d-block d-md-none' style="transform: rotate(90deg);"></i>
                <span>FİLTRELE</span>
            </div>

            <div class="p-3 h-100 overflow-auto">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold m-0">Filtrele</h6>
                    <button class="btn btn-sm btn-link text-danger text-decoration-none p-0" (click)="resetAllFilters()">Temizle</button>
                    <button class="btn btn-sm btn-light rounded-circle" (click)="toggleFilter()">
                        <i class='bx bx-x fs-5'></i>
                    </button>
                </div>

                <div class="card bg-light border-0 mb-4">
                    <div class="card-body p-2">
                        <div class="form-check form-switch d-flex align-items-center justify-content-between ps-0">
                            <label class="form-check-label small fw-bold text-primary mb-0 cursor-pointer" for="privateSwitch">
                                <i class='bx bxs-lock-alt me-1'></i> Kuruma Özel
                            </label>
                            <input class="form-check-input ms-0 cursor-pointer" type="checkbox" id="privateSwitch" 
                                   style="width: 40px; height: 20px;"
                                   (change)="onPrivateChange($event)" [checked]="filterRequest.onlyPrivate">
                        </div>
                    </div>
                </div>

                <div class="mb-4" *ngIf="allCategories.length > 0">
                    <h6 class="small fw-bold text-muted mb-2 text-uppercase ls-1">Kategoriler</h6>
                    <div class="mb-2 position-relative">
                        <input type="text" class="form-control form-control-sm" placeholder="Kategori ara..."
                               [(ngModel)]="categorySearchText" (keyup)="filterCategoriesOnUI()">
                        <i class='bx bx-search position-absolute top-50 end-0 translate-middle-y me-2 text-muted'></i>
                    </div>
                    <div class="filter-scroll-area custom-scrollbar" style="max-height: 300px; overflow-y: auto;">
                        <div *ngFor="let cat of filteredCategories" class="position-relative">
                            <div class="form-check mb-1" 
                                 [style.margin-left.px]="cat.level * 20"
                                 [class.mt-3]="cat.level === 0 && filteredCategories.indexOf(cat) !== 0"
                                 [class.mt-1]="cat.level > 0">
                                <div *ngIf="cat.level > 0" class="position-absolute"
                                     style="left: -12px; top: 0; bottom: 0; width: 1px; background-color: #e0e0e0;">
                                     <div style="position: absolute; top: 12px; left: 0; width: 10px; height: 1px; background-color: #e0e0e0;"></div>
                                </div>
                                <input class="form-check-input" type="checkbox" [id]="'cat'+cat.id" [value]="cat.id"
                                       [checked]="isCategorySelected(cat.id)"
                                       (change)="onCategoryChange(cat, $event)">
                                <label class="form-check-label small cursor-pointer" [for]="'cat'+cat.id" 
                                       [style.font-weight]="cat.level === 0 ? '700' : '400'"
                                       [class.text-dark]="cat.level === 0"
                                       [class.text-muted]="cat.level > 0">
                                    {{ cat.title }}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h6 class="small fw-bold text-muted mb-2 text-uppercase ls-1">Puan</h6>
                    <ul class="list-unstyled mb-0">
                        <li *ngFor="let rate of ratings" 
                            class="cursor-pointer mb-1 p-1 rounded transition-all" 
                            [class.bg-light-primary]="filterRequest.minRating === rate"
                            [class.border-start]="filterRequest.minRating === rate"
                            [style.border-left-width.px]="filterRequest.minRating === rate ? 3 : 0"
                            style="border-color: var(--primaryColor);"
                            (click)="onRatingChange(rate)">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <span class="d-inline-block me-2">
                                        <i class='bx bxs-star text-warning' *ngFor="let s of [1,2,3,4,5]" 
                                           [ngClass]="{'bx-star text-muted': s > rate}"></i>
                                    </span>
                                    <span class="small text-muted">{{ rate }} & Üzeri</span>
                                </div>
                                <i *ngIf="filterRequest.minRating === rate" class='bx bx-check text-primary'></i>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="mb-4" *ngIf="levels.length > 0">
                    <h6 class="small fw-bold text-muted mb-2 text-uppercase ls-1">Seviye</h6>
                    <div *ngFor="let lvl of levels" class="form-check mb-1">
                        <input class="form-check-input" type="checkbox" [id]="'lvl'+lvl.id" [value]="lvl.id"
                               [checked]="filterRequest.levelIds?.includes(lvl.id)"
                               (change)="onFilterChange($event, 'level')">
                        <label class="form-check-label small" [for]="'lvl'+lvl.id">{{ lvl.title }}</label>
                    </div>
                </div>

                <div class="mb-4" *ngIf="languages.length > 0">
                    <h6 class="small fw-bold text-muted mb-2 text-uppercase ls-1">Dil</h6>
                    <div *ngFor="let lang of languages" class="form-check mb-1">
                        <input class="form-check-input" type="checkbox" [id]="'lang'+lang.id" [value]="lang.id"
                               [checked]="filterRequest.languageIds?.includes(lang.id)"
                               (change)="onFilterChange($event, 'language')">
                        <label class="form-check-label small" [for]="'lang'+lang.id">{{ lang.title }}</label>
                    </div>
                </div>
                
                <div class="mb-4" *ngIf="instructors.length > 0">
                    <h6 class="small fw-bold text-muted mb-2 text-uppercase ls-1">Eğitmenler</h6>
                    <div class="filter-scroll-area custom-scrollbar" style="max-height: 200px; overflow-y: auto;">
                        <div *ngFor="let inst of instructors" class="form-check mb-1">
                            <input class="form-check-input" type="checkbox" [id]="'inst'+inst.id" [value]="inst.id"
                                   [checked]="filterRequest.instructorIds?.includes(inst.id)"
                                   (change)="onFilterChange($event, 'instructor')">
                            <label class="form-check-label small" [for]="'inst'+inst.id">{{ inst.title }}</label>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>