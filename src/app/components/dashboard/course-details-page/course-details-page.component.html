<div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<div *ngIf="!isLoading && training">
    <div class="page-banner-area ptb-100" [style.background-image]="'url(' + (training.headerImage || 'assets/images/shapes/page-banner-bg.jpg') + ')'">
        <div class="container">
            <div class="page-banner-content">
                <div class="list d-sm-flex align-items-center">
                    <div class="list-item d-block">
                        <div class="d-flex align-items-center">
                            <img [src]="training.instructorImage" class="rounded-circle border" width="30" height="30" style="object-fit: cover;">
                            <span class="ms-2 fw-bold text-white">{{ training.instructorName }}</span>
                        </div>
                    </div>
                    <div class="list-item text-white"><i class='bx bx-globe text-warning me-1'></i> {{ training.language }}</div>
                    <div class="list-item text-white"><i class='bx bxs-star text-warning'></i> {{ training.rating | number:'1.1-1' }} ({{ training.reviewCount }})</div>
                </div>
                <h1 class="text-white mb-3">{{ training.title }}</h1>
                <p class="text-white opacity-75 mb-3 d-none d-md-block">{{ training.description | slice:0:150 }}...</p>
            </div>
        </div>
    </div>

    <div class="course-details-area ptb-100">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-md-12">
                    <div class="course-details-desc">
                        <ul class="nav nav-tabs d-block">
                            <li class="nav-item d-inline-block" [class.active]="currentTab === 'tab1'"><button class="nav-link" (click)="switchTab($event, 'tab1')">Genel Bakış</button></li>
                            <li class="nav-item d-inline-block" [class.active]="currentTab === 'tab2'"><button class="nav-link" (click)="switchTab($event, 'tab2')">Müfredat</button></li>
                            <li class="nav-item d-inline-block" [class.active]="currentTab === 'tab3'"><button class="nav-link" (click)="switchTab($event, 'tab3')">Eğitmen</button></li>
                            <li class="nav-item d-inline-block" [class.active]="currentTab === 'tab4'"><button class="nav-link" (click)="switchTab($event, 'tab4')">Yorumlar</button></li>
                        </ul>

                        <div class="tab-content">
                            <div class="tab-pane fade show active" *ngIf="currentTab === 'tab1'">
                                <div class="overview-details-content">
                                    <h4>Açıklama</h4>
                                    <div [innerHTML]="training.description" class="text-muted" style="line-height: 1.8;"></div>
                                    <div *ngIf="training.whatYouWillLearn?.length > 0" class="mt-4">
                                        <h4>Neler Öğreneceksiniz?</h4>
                                        <ul class="features-list ps-0 list-unstyled d-flex flex-wrap">
                                            <li *ngFor="let item of training.whatYouWillLearn"><span><i class="flaticon-tick"></i> {{ item }}</span></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade show active" *ngIf="currentTab === 'tab2'">
                                <div class="course-details-content mb-0">
                                    <h4>Ders İçeriği</h4>
                                    <div class="accordion">
                                        <div class="accordion-section" *ngFor="let section of training.sections; let i = index">
                                            <div class="accordion-header" (click)="toggleSection(i)" [class.open]="isSectionOpen(i)">
                                                {{ section.title }}
                                                <span class="text-muted small">{{ section.contents?.length || 0 }} ders</span>
                                            </div>
                                            <div class="accordion-content" [class.open]="isSectionOpen(i)" [style.display]="isSectionOpen(i) ? 'block' : 'none'">
                                                <ul class="ps-0 mb-0 list-unstyled">
                                                    <li *ngFor="let content of section.contents" class="d-sm-flex align-items-center justify-content-between">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <i class='bx' [ngClass]="content.isPreview ? 'bx-play-circle text-primary fs-5' : 'bx-lock-alt text-muted fs-5'"></i>
                                                            <span [class.text-primary]="content.isPreview">{{ content.title }}</span>
                                                        </div>
                                                        <span class="text-muted small">{{ content.durationMinutes }} dk</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade show active" *ngIf="currentTab === 'tab3'">
                                <div class="course-details-instructor">
                                    <div class="user d-flex align-items-center">
                                        <img [src]="training.instructorImage" class="rounded-circle border" width="80" height="80">
                                        <div class="ms-3">
                                            <h6>{{ training.instructorName }}</h6>
                                            <span class="text-muted">{{ training.instructorTitle }}</span>
                                        </div>
                                    </div>
                                    <p class="mt-3">{{ training.instructorBio }}</p>
                                </div>
                            </div>
                            <div class="tab-pane fade show active" *ngIf="currentTab === 'tab4'">
                                <div class="course-details-feedback">
                                    <h4>Yorumlar ({{ training.reviewCount }})</h4>
                                    <div *ngFor="let review of training.topReviews" class="feedback-item d-flex gap-3 mb-3 border-bottom pb-3">
                                        <img [src]="review.userImage" class="rounded-circle" width="50" height="50">
                                        <div>
                                            <h6 class="mb-1">{{ review.userName }}</h6>
                                            <div class="text-warning x-small"><i class="bx bxs-star" *ngFor="let s of [1,2,3,4,5]" [class.bx-star]="s > review.rating"></i></div>
                                            <p class="mt-1 text-muted">{{ review.comment }}</p>
                                        </div>
                                    </div>
                                    <div *ngIf="training.topReviews?.length === 0" class="text-center text-muted p-3">Henüz yorum yok.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 col-md-12">
                    <div class="course-details-info sticky-top" style="top: 100px; z-index: 90;">
                        <div class="image position-relative rounded-top overflow-hidden">
                            <img [src]="training.headerImage" class="img-fluid w-100" style="height: 200px; object-fit: cover;">
                            <div class="overlay-dark position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-25" *ngIf="training.previewVideoPath"></div>
                            <button *ngIf="training.previewVideoPath" class="video-btn p-0 border-0 rounded-circle position-absolute top-50 start-50 translate-middle" (click)="openPopup()">
                                <i class='bx bx-play text-white ps-1 fs-1'></i>
                            </button>
                        </div>
                        <div class="content p-4 bg-white shadow-sm border border-top-0 rounded-bottom">
                            <div class="text-center mb-3">
                                <h3 class="text-primary mb-0">{{ training.currentAmount | currency:'TRY':'symbol-narrow':'1.0-0' }}</h3>
                                <span *ngIf="training.discountRate > 0" class="text-muted text-decoration-line-through">{{ training.amount | currency:'TRY':'symbol-narrow':'1.0-0' }}</span>
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" (click)="addToCart()">Sepete Ekle</button>
                                <button class="btn btn-outline-secondary" (click)="buyNow()">Hemen Al</button>
                            </div>
                            <ul class="list-unstyled mt-3 small text-muted">
                                <li class="d-flex justify-content-between mb-2"><span>Süre:</span> <span class="fw-bold text-dark">50 Saat</span></li>
                                <li class="d-flex justify-content-between mb-2"><span>Seviye:</span> <span class="fw-bold text-dark">{{ training.levelName }}</span></li>
                                <li class="d-flex justify-content-between mb-2"><span>Dil:</span> <span class="fw-bold text-dark">{{ training.language }}</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="video-popup-overlay" *ngIf="isOpen" (click)="closePopup()">
        <div class="popup-inner shadow-lg" (click)="$event.stopPropagation()">
            <button (click)="closePopup()" class="btn btn-sm btn-light rounded-circle float-end mb-2"><i class='bx bx-x fs-4'></i></button>
            <div class="ratio ratio-16x9 bg-black rounded">
                <iframe [src]="safeVideoUrl" allowfullscreen></iframe>
            </div>
        </div>
    </div>
</div>